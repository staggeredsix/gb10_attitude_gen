<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LTX-2 Fever Dream + Mood Mirror</title>
    <style>
      body {
        font-family: "Inter", "Segoe UI", sans-serif;
        background: #0b0d14;
        color: #e6e9f2;
        margin: 0;
        padding: 0;
      }
      header {
        padding: 24px 32px;
        background: #131826;
        border-bottom: 1px solid #1f2636;
      }
      main {
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 24px;
        padding: 24px 32px;
      }
      .panel {
        background: #121522;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid #1f2636;
      }
      label {
        display: block;
        font-size: 0.85rem;
        margin-top: 12px;
        margin-bottom: 4px;
        color: #b8c0d8;
      }
      input,
      textarea,
      select,
      button {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #2b3247;
        background: #0d111c;
        color: #e6e9f2;
      }
      textarea {
        min-height: 70px;
      }
      button {
        background: #4b7bff;
        border: none;
        font-weight: 600;
        cursor: pointer;
      }
      button:hover {
        background: #3b6af0;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
      }
      .stream {
        background: #0d111c;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #20263b;
      }
      .stream img {
        width: 100%;
        display: block;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .status {
        margin-top: 12px;
        font-size: 0.85rem;
        color: #9aa4bf;
      }
      .mood-values {
        font-size: 0.85rem;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>AI Fever Dream + AI Mood Mirror (LTX-2)</h1>
      <p>Generate looping LTX-2 videos from prompts or mirror your live mood from the webcam.</p>
    </header>
    <main>
      <section class="panel">
        <label for="mode">Mode</label>
        <select id="mode">
          <option value="fever">AI Fever Dream</option>
          <option value="mood">AI Mood Mirror</option>
        </select>

        <label for="prompt">Prompt</label>
        <textarea id="prompt"></textarea>

        <label for="negativePrompt">Negative prompt</label>
        <textarea id="negativePrompt" placeholder="e.g., people, faces, text, watermark"></textarea>

        <label for="resolution">Resolution</label>
        <select id="resolution">
          <option value="1280x736">1280 × 736 (near 720p)</option>
          <option value="1024x576">1024 × 576</option>
          <option value="960x544">960 × 544</option>
          <option value="640x384">640 × 384</option>
          <option value="custom">Custom</option>
        </select>

        <label for="outputMode">Output mode</label>
        <select id="outputMode">
          <option value="native">Native (one-stage output)</option>
          <option value="upscaled">Upscaled (two-stage refinement)</option>
        </select>

        <label class="inline-toggle">
          <input id="muteToggle" type="checkbox" />
          Mute audio (if available)
        </label>

        <audio id="audioPlayer" controls loop style="width: 100%; margin-top: 8px;"></audio>

        <div class="row">
          <div>
            <label for="width">Width</label>
            <input id="width" type="number" min="256" step="32" />
          </div>
          <div>
            <label for="height">Height</label>
            <input id="height" type="number" min="256" step="32" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="fps">FPS</label>
            <input id="fps" type="number" min="1" max="60" />
          </div>
          <div>
            <label for="streams">Streams</label>
            <input id="streams" type="number" min="1" max="16" />
          </div>
        </div>

        <label for="seed">Seed (optional)</label>
        <input id="seed" type="number" placeholder="Leave empty for random" />

        <label for="dreamStrength">Dream strength</label>
        <input id="dreamStrength" type="range" min="0" max="1" step="0.05" />

        <label for="motion">Motion</label>
        <input id="motion" type="range" min="0" max="1" step="0.05" />

        <div id="moodControls">
          <label for="basePrompt">Mood Mirror base prompt</label>
          <textarea id="basePrompt"></textarea>

          <label for="identityStrength">Retain identity → Abstract mirror</label>
          <input id="identityStrength" type="range" min="0" max="1" step="0.05" />

          <button id="webcamToggle" type="button">Enable webcam</button>
          <div class="mood-values" id="moodValues">Mood: waiting for camera…</div>
        </div>

        <div class="row">
          <button id="startButton" type="button">Start dreaming</button>
          <button id="applyButton" type="button">Update dream</button>
        </div>
        <div class="status" id="status"></div>
      </section>

      <section class="panel">
        <h3>Streams</h3>
        <div class="grid" id="streamGrid"></div>
      </section>

      <section class="panel">
        <h3>Video-to-Video (IC-LoRA)</h3>
        <div class="dropzone" id="v2vDropzone">
          <strong>Drop a video here</strong> or click to select a file.
          <input id="v2vFile" type="file" accept="video/*" style="display: none;" />
        </div>
        <label for="v2vPrompt">V2V Prompt</label>
        <textarea id="v2vPrompt" placeholder="The main character runs down a street"></textarea>
        <div class="row">
          <div>
            <label for="v2vStrength">Strength</label>
            <input id="v2vStrength" type="number" min="0" max="1" step="0.05" value="0.7" />
          </div>
          <div>
            <label for="v2vSeconds">Seconds</label>
            <input id="v2vSeconds" type="number" min="1" max="8" step="1" value="4" />
          </div>
        </div>
        <button id="v2vSubmit" type="button">Generate Video</button>
        <div class="status" id="v2vStatus"></div>
        <video id="v2vPreview" controls style="width: 100%; margin-top: 8px; display: none;"></video>
      </section>
    </main>

    <video id="webcamVideo" autoplay playsinline style="display: none;"></video>
    <canvas id="webcamCanvas" width="640" height="360" style="display: none;"></canvas>

    <script>
      const modeSelect = document.getElementById("mode");
      const promptInput = document.getElementById("prompt");
      const negativePromptInput = document.getElementById("negativePrompt");
      const resolutionSelect = document.getElementById("resolution");
      const outputModeSelect = document.getElementById("outputMode");
      const muteToggle = document.getElementById("muteToggle");
      const audioPlayer = document.getElementById("audioPlayer");
      const widthInput = document.getElementById("width");
      const heightInput = document.getElementById("height");
      const fpsInput = document.getElementById("fps");
      const streamsInput = document.getElementById("streams");
      const seedInput = document.getElementById("seed");
      const dreamStrengthInput = document.getElementById("dreamStrength");
      const motionInput = document.getElementById("motion");
      const basePromptInput = document.getElementById("basePrompt");
      const identityStrengthInput = document.getElementById("identityStrength");
      const applyButton = document.getElementById("applyButton");
      const startButton = document.getElementById("startButton");
      const status = document.getElementById("status");
      const streamGrid = document.getElementById("streamGrid");
      const moodControls = document.getElementById("moodControls");
      const webcamToggle = document.getElementById("webcamToggle");
      const moodValues = document.getElementById("moodValues");
      const webcamVideo = document.getElementById("webcamVideo");
      const webcamCanvas = document.getElementById("webcamCanvas");
      const webcamCtx = webcamCanvas.getContext("2d");
      const v2vDropzone = document.getElementById("v2vDropzone");
      const v2vFile = document.getElementById("v2vFile");
      const v2vPrompt = document.getElementById("v2vPrompt");
      const v2vStrength = document.getElementById("v2vStrength");
      const v2vSeconds = document.getElementById("v2vSeconds");
      const v2vSubmit = document.getElementById("v2vSubmit");
      const v2vStatus = document.getElementById("v2vStatus");
      const v2vPreview = document.getElementById("v2vPreview");
      let webcamStream = null;
      let webcamInterval = null;
      let currentStreamsCount = parseInt(streamsInput.value || "1", 10);
      let lastAudioUpdate = 0;

      function setStatus(message) {
        status.textContent = message;
      }

      function setV2vStatus(message) {
        v2vStatus.textContent = message;
      }

      function updateMoodControls() {
        moodControls.style.display = modeSelect.value === "mood" ? "block" : "none";
      }

      function buildConfig() {
        return {
          mode: modeSelect.value,
          prompt: promptInput.value.trim(),
          negative_prompt: negativePromptInput.value.trim(),
          width: parseInt(widthInput.value, 10),
          height: parseInt(heightInput.value, 10),
          fps: parseInt(fpsInput.value, 10),
          streams: parseInt(streamsInput.value, 10),
          output_mode: outputModeSelect.value,
          seed: seedInput.value ? parseInt(seedInput.value, 10) : null,
          dream_strength: parseFloat(dreamStrengthInput.value),
          motion: parseFloat(motionInput.value),
          base_prompt: basePromptInput.value.trim(),
          identity_strength: parseFloat(identityStrengthInput.value),
        };
      }

      async function applyConfig({ start = false } = {}) {
        setStatus(start ? "Starting dream..." : "Updating dream...");
        const config = buildConfig();
        const response = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(config),
        });
        if (!response.ok) {
          const data = await response.json();
          setStatus(`Error: ${data.detail}`);
          return;
        }
        const updated = await response.json();
        if (start) {
          await fetch("/api/start", { method: "POST" });
        }
        setStatus(start ? "Dream started." : "Dream updated.");
        if (updated.streams !== currentStreamsCount) {
          currentStreamsCount = updated.streams;
          buildStreams(updated.streams);
        }
      }

      function buildStreams(count) {
        streamGrid.innerHTML = "";
        for (let i = 0; i < count; i++) {
          const wrapper = document.createElement("div");
          wrapper.className = "stream";
          const img = document.createElement("img");
          img.src = `/stream/${i}.mjpg?ts=${Date.now()}`;
          wrapper.appendChild(img);
          streamGrid.appendChild(wrapper);
        }
      }

      function applyMuteState() {
        const muted = !!muteToggle.checked;
        document.querySelectorAll("video, audio").forEach((el) => {
          el.muted = muted;
          if ("volume" in el) {
            el.volume = muted ? 0.0 : 1.0;
          }
        });
      }

      function handleV2vFile(file) {
        if (!file) {
          return;
        }
        const dt = new DataTransfer();
        dt.items.add(file);
        v2vFile.files = dt.files;
        setV2vStatus(`Selected: ${file.name}`);
      }

      async function submitV2v() {
        const file = v2vFile.files[0];
        if (!file) {
          setV2vStatus("Please select a video file.");
          return;
        }
        if (!v2vPrompt.value.trim()) {
          setV2vStatus("Please enter a prompt.");
          return;
        }
        setV2vStatus("Generating video...");
        const form = new FormData();
        form.append("file", file);
        form.append("prompt", v2vPrompt.value.trim());
        form.append("strength", String(v2vStrength.value || "0.7"));
        form.append("seconds", String(v2vSeconds.value || "4"));
        try {
          const response = await fetch("/api/v2v", { method: "POST", body: form });
          if (!response.ok) {
            const data = await response.json();
            setV2vStatus(`Error: ${data.detail || "request failed"}`);
            return;
          }
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          v2vPreview.src = url;
          v2vPreview.style.display = "block";
          setV2vStatus("Done.");
        } catch (err) {
          setV2vStatus(`Error: ${err}`);
        }
      }

      async function loadConfig() {
        const response = await fetch("/api/config");
        const config = await response.json();
        modeSelect.value = config.mode;
        promptInput.value = config.prompt;
        negativePromptInput.value = config.negative_prompt || "";
        widthInput.value = config.width;
        heightInput.value = config.height;
        const presetValue = `${config.width}x${config.height}`;
        const hasPreset = Array.from(resolutionSelect.options).some((opt) => opt.value === presetValue);
        resolutionSelect.value = hasPreset ? presetValue : "custom";
        outputModeSelect.value = config.output_mode || "native";
        fpsInput.value = config.fps;
        streamsInput.value = config.streams;
        seedInput.value = config.seed ?? "";
        dreamStrengthInput.value = config.dream_strength;
        motionInput.value = config.motion;
        basePromptInput.value = config.base_prompt;
        identityStrengthInput.value = config.identity_strength;
        updateMoodControls();
        currentStreamsCount = config.streams;
        buildStreams(config.streams);
      }

      async function pollAudioStatus() {
        try {
          const response = await fetch("/audio/status?stream=0");
          if (!response.ok) return;
          const status = await response.json();
          if (!status.available) return;
          if (status.updated_at && status.updated_at !== lastAudioUpdate) {
            lastAudioUpdate = status.updated_at;
            audioPlayer.src = `/audio/latest.wav?stream=0&ts=${Date.now()}`;
            audioPlayer.currentTime = 0;
            if (!muteToggle.checked) {
              audioPlayer.play().catch(() => {});
            }
          }
        } catch (_) {
          return;
        }
      }

      async function sendMoodFrame() {
        if (!webcamStream) {
          return;
        }
        webcamCanvas.width = webcamVideo.videoWidth || 640;
        webcamCanvas.height = webcamVideo.videoHeight || 360;
        webcamCtx.drawImage(webcamVideo, 0, 0, webcamCanvas.width, webcamCanvas.height);
        const blob = await new Promise((resolve) => webcamCanvas.toBlob(resolve, "image/jpeg", 0.7));
        if (!blob) return;
        const response = await fetch("/api/mood/frame", { method: "POST", body: blob });
        if (response.ok) {
          const mood = await response.json();
          moodValues.textContent = `Mood: valence ${mood.valence.toFixed(2)} | arousal ${mood.arousal.toFixed(2)} | ${
            mood.labels.join(", ") || "neutral"
          }`;
        }
      }

      async function toggleWebcam() {
        if (webcamStream) {
          webcamStream.getTracks().forEach((track) => track.stop());
          webcamStream = null;
          clearInterval(webcamInterval);
          webcamInterval = null;
          webcamToggle.textContent = "Enable webcam";
          moodValues.textContent = "Mood: webcam disabled.";
          return;
        }
        try {
          webcamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          webcamVideo.srcObject = webcamStream;
          webcamToggle.textContent = "Disable webcam";
          webcamInterval = setInterval(sendMoodFrame, 200);
        } catch (error) {
          moodValues.textContent = `Webcam error: ${error}`;
        }
      }

      modeSelect.addEventListener("change", updateMoodControls);
      startButton.addEventListener("click", () => applyConfig({ start: true }));
      applyButton.addEventListener("click", () => applyConfig({ start: false }));
      muteToggle.addEventListener("change", applyMuteState);
      resolutionSelect.addEventListener("change", () => {
        if (resolutionSelect.value === "custom") {
          return;
        }
        const [w, h] = resolutionSelect.value.split("x").map((v) => parseInt(v, 10));
        if (!Number.isNaN(w) && !Number.isNaN(h)) {
          widthInput.value = w;
          heightInput.value = h;
        }
      });
      webcamToggle.addEventListener("click", toggleWebcam);
      v2vDropzone.addEventListener("click", () => v2vFile.click());
      v2vDropzone.addEventListener("dragover", (event) => {
        event.preventDefault();
        v2vDropzone.classList.add("dragover");
      });
      v2vDropzone.addEventListener("dragleave", () => v2vDropzone.classList.remove("dragover"));
      v2vDropzone.addEventListener("drop", (event) => {
        event.preventDefault();
        v2vDropzone.classList.remove("dragover");
        const file = event.dataTransfer.files[0];
        handleV2vFile(file);
      });
      v2vFile.addEventListener("change", () => handleV2vFile(v2vFile.files[0]));
      v2vSubmit.addEventListener("click", submitV2v);

      loadConfig();
      applyMuteState();
      setInterval(pollAudioStatus, 1500);
    </script>
  </body>
</html>
